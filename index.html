<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>すうじタップゲーム（ビジョントレーニング）</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <style>
    :root{
      --board: min(92vmin, 420px);
      --cell: clamp(44px, 11vmin, 72px);
      --fg: #111;
      --bg: #f5f5f5;
      --acc: #4caf50;
      --card: #fff;
      --border: #e5e7eb;
    }
    *, *::before, *::after{ box-sizing: border-box; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, "Segoe UI", "Noto Sans JP", sans-serif;
      color:var(--fg);
      background:var(--bg);
      -webkit-tap-highlight-color: transparent;
    }
    header{ padding:16px 20px; text-align:center; }
    h1{ margin:0 0 6px; font-size:clamp(18px, 4.6vw, 28px); font-weight:700; }
    .sub{ color:#666; font-size:clamp(12px, 3.2vw, 14px); }
    .container{ max-width: 720px; margin: 0 auto; padding: 12px 16px 28px; }
    .panel{
      background:var(--card); border:1px solid var(--border); border-radius:14px;
      padding:14px; display:flex; flex-direction:column; gap:12px; align-items:center;
      box-shadow: 0 2px 8px rgba(0,0,0,.03);
    }
    #gameWrap{ display:flex; flex-direction:column; align-items:center; gap:10px; }
    #game{
      position: relative;
      width: var(--board);
      height: var(--board);
      min-width: 260px;   /* 念のための下限 */
      min-height: 260px;  /* 念のための下限 */
      background:#fff; border:1px solid var(--border); border-radius:16px;
      touch-action: manipulation; user-select:none; overflow:hidden;
    }
    .number{
      position:absolute;
      width: var(--cell);
      height: var(--cell);
      line-height: var(--cell);
      background: var(--acc); color:#fff; border-radius: 999px;
      text-align:center; font-weight:700; font-size: clamp(16px, 4.2vmin, 28px);
      cursor: pointer; box-shadow: 0 2px 6px rgba(0,0,0,.15); transition: transform .08s ease;
      will-change: transform;
    }
    .number:active{ transform: scale(.96); }
    .square{ border-radius: 14px; }
    .star{
      clip-path: polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%,
                         79% 91%, 50% 70%, 21% 91%, 32% 57%,
                         2% 35%, 39% 35%);
      border-radius: 0;
    }
    .row{ display:flex; flex-wrap:wrap; gap:10px 12px; align-items:center; justify-content:center; }
    label{ font-size: clamp(13px, 3.4vw, 15px); color:#333; }
    select, button{
      font-size: clamp(14px, 3.8vw, 16px);
      padding: 10px 16px; border:1px solid var(--border); border-radius: 10px; background:#fff; cursor:pointer;
    }
    button.primary{ background: var(--acc); color:#fff; border-color: transparent; }
    .meters{ display:flex; gap:14px; flex-wrap:wrap; justify-content:center; font-size: clamp(14px, 3.8vw, 18px); }
    .badge{ background:#eef7ee; border:1px solid #d7ecd7; color:#2f6b2f; border-radius:999px; padding:6px 10px; }
    .muted{ color:#666; }
  </style>
</head>
<body>
  <header>
    <h1>数字タップゲーム</h1>
    <div class="sub">ちいさいじゅんにタップしてね</div>
  </header>

  <main class="container">
    <section class="panel" id="gameWrap">
      <div id="game" aria-label="ゲーム盤面"></div>

      <div class="meters">
        <div id="timer" class="badge">タイム: 0.00 秒</div>
        <div id="best" class="badge">ベスト: なし</div>
      </div>

      <div class="row">
        <label for="range">レベル：</label>
        <select id="range" aria-label="難易度">
          <option value="10">1〜10</option>
          <option value="20">1〜20</option>
          <option value="30">1〜30</option>
        </select>

        <label for="shapeSel">かたち：</label>
        <select id="shapeSel" aria-label="形">
          <option value="circle">円形</option>
          <option value="grid">グリッド</option>
          <option value="star">スター風</option>
        </select>
      </div>

      <div class="row">
        <button class="primary" id="startBtn">スタート</button>
        <button id="resetBtn">もういちど</button>
      </div>
      <div class="muted" style="text-align:center;">※ 「スタート」で　はじまるよ。</div>
    </section>
  </main>

  <script>
    const game = document.getElementById("game");
    const timerDisplay = document.getElementById("timer");
    const bestDisplay = document.getElementById("best");
    const rangeSel = document.getElementById("range");
    const shapeSel = document.getElementById("shapeSel");
    const startBtn = document.getElementById("startBtn");
    const resetBtn = document.getElementById("resetBtn");

    let maxNumber = parseInt(rangeSel.value, 10);
    let numbers = [];
    let nextNumber = 1;
    let timer = 0;
    let interval = null;
    let gameStarted = false;
    let shape = shapeSel.value;

    // ◇ 盤面サイズの取得を強化
    function measureBoard() {
      const rect = game.getBoundingClientRect();
      let w = rect.width;
      let h = rect.height;

      if (!w || !h) {
        // 安全なフォールバック（Chrome初期0対策）
        const px = Math.max(260, Math.min(Math.floor(Math.min(window.innerWidth, window.innerHeight) * 0.92), 420));
        game.style.width = px + "px";
        game.style.height = px + "px";
        w = px; h = px;
      }
      return { w, h };
    }

    // CSS変数のセル基準値
    function baseCell() {
      const v = getComputedStyle(document.documentElement).getPropertyValue('--cell').trim();
      // "56.4px" → 56.4
      const px = parseFloat(v);
      return isNaN(px) ? 56 : px;
    }

    // ベストタイム
    const bestKey = () => `vtap_best_${maxNumber}`;
    function loadBest(){
      const v = localStorage.getItem(bestKey());
      bestDisplay.textContent = v ? `ベスト: ${parseFloat(v).toFixed(2)} 秒` : 'ベスト: なし';
    }
    function updateBest(t){
      const prev = parseFloat(localStorage.getItem(bestKey()));
      if(isNaN(prev) || t < prev){
        localStorage.setItem(bestKey(), String(t));
        loadBest();
      }
    }

    function startGame(){
      if (gameStarted) return;
      timer = 0;
      timerDisplay.textContent = "タイム: 0.00 秒";
      interval = setInterval(() => {
        timer += 0.01;
        timerDisplay.textContent = `タイム: ${timer.toFixed(2)} 秒`;
      }, 10);
      gameStarted = true;
    }
    function stopGame(){ clearInterval(interval); interval=null; gameStarted=false; }
    function resetGame(){ stopGame(); nextNumber=1; timer=0; timerDisplay.textContent="タイム: 0.00 秒"; generateNumbers(); }

    function shuffle(array){
      for(let i = array.length - 1; i > 0; i--){
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
    }

    function generateNumbers(){
      const { w, h } = measureBoard();

      game.innerHTML = "";
      numbers = Array.from({length:maxNumber}, (_,i)=> i+1);
      shuffle(numbers);

      // セルサイズの決定（グリッドは盤面に合わせてさらに調整）
      let cell = baseCell();
      const half = cell/2;
      const coords = [];
      const gap = 8;

      if(shape === 'circle'){
        const n = numbers.length;
        const cx = w/2, cy = h/2;
        const outerR = Math.min(w, h)/2 - half - 6;
        const innerR = outerR * 0.6;

        if(n <= 12){
          for(let i=0;i<n;i++){
            const ang = (i/n)*Math.PI*2 - Math.PI/2;
            coords.push([cx + outerR*Math.cos(ang) - half, cy + outerR*Math.sin(ang) - half]);
          }
        }else{
          const outerN = Math.ceil(n*0.6);
          const innerN = n - outerN;
          for(let i=0;i<outerN;i++){
            const ang = (i/outerN)*Math.PI*2 - Math.PI/2;
            coords.push([cx + outerR*Math.cos(ang) - half, cy + outerR*Math.sin(ang) - half]);
          }
          for(let i=0;i<innerN;i++){
            const ang = (i/innerN)*Math.PI*2 - Math.PI/2;
            coords.push([cx + innerR*Math.cos(ang) - half, cy + innerR*Math.sin(ang) - half]);
          }
        }
      } else if(shape === 'grid'){
        const n = numbers.length;
        const cols = Math.ceil(Math.sqrt(n));
        const rows = Math.ceil(n / cols);

        // 盤面に確実に収めるセルサイズへ調整
        const maxCellW = (w - gap*(cols-1)) / cols;
        const maxCellH = (h - gap*(rows-1)) / rows;
        cell = Math.min(cell, maxCellW, maxCellH, 96); // 上限ガード
        const startX = (w - (cols*cell + (cols-1)*gap)) / 2;
        const startY = (h - (rows*cell + (rows-1)*gap)) / 2;

        for(let i=0;i<n;i++){
          const r = Math.floor(i/cols);
          const c = i % cols;
          const x = startX + c*(cell+gap);
          const y = startY + r*(cell+gap);
          coords.push([x,y]);
        }
      } else { // star
        const n = numbers.length;
        const cx = w/2, cy = h/2;
        const outerR = Math.min(w, h)/2 - half - 6;
        const innerR = outerR * 0.5;
        for(let i=0;i<n;i++){
          const ang = (i/n)*Math.PI*2 - Math.PI/2;
          const r = (i % 2 === 0) ? outerR : innerR;
          coords.push([cx + r*Math.cos(ang) - half, cy + r*Math.sin(ang) - half]);
        }
      }

      numbers.forEach((num, i) => {
        const div = document.createElement("div");
        div.className = "number";
        if(shape === 'grid') div.classList.add('square');
        if(shape === 'star') div.classList.add('star');

        // セルサイズをJSでも明示（Chrome初期0の影響を避ける）
        div.style.width = cell + "px";
        div.style.height = cell + "px";
        div.style.lineHeight = cell + "px";

        div.textContent = num;
        const [x,y] = coords[i];
        div.style.left = `${x}px`;
        div.style.top = `${y}px`;
        div.addEventListener('click', () => {
          if (!gameStarted) return;
          if (num === nextNumber) {
            div.style.visibility = "hidden";
            nextNumber++;
            if (nextNumber > maxNumber) {
              stopGame();
              updateBest(timer);
            }
          }
        }, {passive:true});
        game.appendChild(div);
      });
    }

    // ResizeObserverで盤面サイズ変化を検知し再配置
    const ro = new ResizeObserver(() => {
      // 連打防止のデバウンス
      clearTimeout(ro._t);
      ro._t = setTimeout(() => generateNumbers(), 80);
    });
    ro.observe(game);

    // イベント
    startBtn.addEventListener('click', startGame);
    resetBtn.addEventListener('click', resetGame);
    rangeSel.addEventListener('change', () => { maxNumber = parseInt(rangeSel.value, 10); loadBest(); resetGame(); });
    shapeSel.addEventListener('change', () => { shape = shapeSel.value; generateNumbers(); });

    // 初期化：描画後に実寸取得して生成
    document.addEventListener('DOMContentLoaded', () => {
      loadBest();
      // 一度 rAF を挟んでから生成（Chrome描画完了待ち）
      requestAnimationFrame(() => generateNumbers());
    });
  </script>
</body>
</html>
